<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Model data with missing observations using multiple imputation • multimput</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Model data with missing observations using multiple imputation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">multimput</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.14</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/impute.html">Tutorial</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-contributing" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Contributing</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-contributing">
<li><a class="dropdown-item" href="../CONTRIBUTING.html">Contributing</a></li>
    <li><a class="dropdown-item" href="../CODE_OF_CONDUCT.html">Code of conduct</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/inbo/multimput/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Model data with missing observations using multiple imputation</h1>
                        <h4 data-toc-skip class="author">Thierry
Onkelinx</h4>
            
            <h4 data-toc-skip class="date">2018-01-12</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/inbo/multimput/blob/main/vignettes/impute.Rmd" class="external-link"><code>vignettes/impute.Rmd</code></a></small>
      <div class="d-none name"><code>impute.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="the-multimput-package">The <code>multimput</code> package<a class="anchor" aria-label="anchor" href="#the-multimput-package"></a>
</h2>
<p>The <code>multimput</code> package was originally intended to provide
the data and code to replicate the results of <span class="citation">Onkelinx, Devos, and Quataert (2016)</span>. This paper
is freely available at <a href="http://dx.doi.org/10.1007/s10336-016-1404-9" class="external-link uri">http://dx.doi.org/10.1007/s10336-016-1404-9</a>. The
functions were all rewritten to make them more user-friendly and more
generic. In order to make the package more compact, we removed the
original code and data starting for version 0.2.6. However both the
original code and data remain available in <a href="https://github.com/inbo/multimput/releases" class="external-link">the older
releases</a>.</p>
</div>
<div class="section level2">
<h2 id="very-short-intro-to-multiple-imputation">Very short intro to multiple imputation<a class="anchor" aria-label="anchor" href="#very-short-intro-to-multiple-imputation"></a>
</h2>
<ol style="list-style-type: decimal">
<li>Create the imputation model</li>
<li>Generate imputations for the missing observation</li>
<li>Aggregate the imputed data</li>
<li>Model the aggregated imputed data</li>
</ol>
</div>
<div class="section level2">
<h2 id="short-intro-to-multiple-imputation">Short intro to multiple imputation<a class="anchor" aria-label="anchor" href="#short-intro-to-multiple-imputation"></a>
</h2>
<p>The imputations are based on a model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>∼</mo><mi>X</mi><msup><mi>β</mi><mo>*</mo></msup></mrow><annotation encoding="application/x-tex">Y \sim X \beta^*</annotation></semantics></math>
which the user has to specify. For a missing value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
with covariates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>i</mi></msub><annotation encoding="application/x-tex">x_i</annotation></semantics></math>,
we draw a random value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_i</annotation></semantics></math>
from the distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>y</mi><mo accent="true">̂</mo></mover><mi>i</mi></msub><annotation encoding="application/x-tex">\hat{y}_i</annotation></semantics></math>.
In case of a linear model, we sample a normal distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>y</mi><mo accent="true">̂</mo></mover><mi>i</mi></msub><mo>,</mo><msub><mi>σ</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y_i \sim N(\hat{y}_i, \sigma_i)</annotation></semantics></math>.
An imputation set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>
holds an impute value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_i</annotation></semantics></math>
for each missing value.</p>
<p>With the missing values replaced by imputation set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>,
the dataset is complete. So we can apply the analysis that we wanted to
do in the first place. This can, but don’t has to, include aggregating
the dataset prior to analysis. The analysis results in a set of
coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><msub><mi>γ</mi><mi>a</mi></msub><mi>l</mi></msub><annotation encoding="application/x-tex">{\gamma_a}_l</annotation></semantics></math>
and their standard error
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><msub><mi>σ</mi><mi>a</mi></msub><mi>l</mi></msub><annotation encoding="application/x-tex">{\sigma_a}_l</annotation></semantics></math>.
Of course, this set will depend on the imputed values of the imputation
set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>l</mi><annotation encoding="application/x-tex">l</annotation></semantics></math>.
Another imputation set has different imputed values and will hence lead
to different coefficients.</p>
<p>Therefore the imputation, aggregation and analysis is repeated for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
different imputation sets, resulting in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>L</mi><annotation encoding="application/x-tex">L</annotation></semantics></math>
sets of coefficients and their standard errors. They are aggregated by
the formulas below. The coefficient will be the average of the
coefficient in all imputation sets. The standard error of a coefficient
is the square root of a sum of two parts. The first part is the average
of the squared standard error in all imputation sets. The second part is
the variance of the coefficient among the imputation sets, multiplied by
a correction factor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mfrac><mn>1</mn><mi>L</mi></mfrac></mrow><annotation encoding="application/x-tex">1 + \frac{1}{L}</annotation></semantics></math>.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>γ</mi><mo accent="true">‾</mo></mover><mi>a</mi></msub><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mi>L</mi></munderover><msub><msub><mi>γ</mi><mi>a</mi></msub><mi>l</mi></msub></mrow><mi>L</mi></mfrac></mrow><annotation encoding="application/x-tex">\bar{\gamma}_a = \frac{\sum_{l = 1}^L{\gamma_a}_l}{L}</annotation></semantics></math><!-- spell-check: ignore --></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover><mi>σ</mi><mo accent="true">‾</mo></mover><mi>a</mi></msub><mo>=</mo><msqrt><mrow><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mi>J</mi></munderover><msub><msubsup><mi>σ</mi><mi>a</mi><mn>2</mn></msubsup><mi>l</mi></msub></mrow><mi>L</mi></mfrac><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>+</mo><mfrac><mn>1</mn><mi>L</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>l</mi><mo>=</mo><mn>1</mn></mrow><mi>L</mi></munderover><msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><msub><mi>γ</mi><mi>a</mi></msub><mi>l</mi></msub><mo>−</mo><msub><mover><mi>γ</mi><mo accent="true">‾</mo></mover><mi>a</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup></mrow><mrow><mi>L</mi><mo>−</mo><mn>1</mn></mrow></mfrac></mrow></msqrt></mrow><annotation encoding="application/x-tex">\bar{\sigma}_a = \sqrt{\frac{\sum_{l = 1}^J {{\sigma_a^2}_l}}{L} + (1 + \frac{1}{L}) \frac{\sum_{l = 1}^L({\gamma_a}_l - \bar{\gamma}_a) ^ 2}{L - 1}}</annotation></semantics></math><!-- spell-check: ignore --></p>
</div>
<div class="section level2">
<h2 id="the-dataset">The dataset<a class="anchor" aria-label="anchor" href="#the-dataset"></a>
</h2>
<p>First, let’s generate a dataset and set some observations missing.
<code>generateData()</code> creates a balanced dataset with repeated
visits of a number of sites. Each site is visited several years and
multiple times per year. Have a look at the help-file of
<code>generateData()</code> for more details on the model.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://doi.org/10.5281/zenodo.598331" class="external-link">multimput</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">prop_missing</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_data.html">generate_data</a></span><span class="op">(</span>n_year <span class="op">=</span> <span class="fl">10</span>, n_period <span class="op">=</span> <span class="fl">6</span>, n_site <span class="op">=</span> <span class="fl">50</span>, n_run <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">Observed</span> <span class="op">&lt;-</span> <span class="va">dataset</span><span class="op">$</span><span class="va">Count</span></span>
<span><span class="va">which_missing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>, size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">*</span> <span class="va">prop_missing</span><span class="op">)</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">Observed</span><span class="op">[</span><span class="va">which_missing</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">fYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">fPeriod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">Period</span><span class="op">)</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">fSite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">Site</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 'data.frame':    3000 obs. of  10 variables:</span></span>
<span><span class="co">##  $ Year    : int  1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">##  $ Period  : int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ Site    : int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ Mu      : num  11.36 9.31 11.33 10.98 9.79 ...</span></span>
<span><span class="co">##  $ Run     : int  1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ Count   : num  8 2 10 21 2 2 13 8 10 4 ...</span></span>
<span><span class="co">##  $ Observed: num  NA 2 10 NA 2 NA 13 NA NA NA ...</span></span>
<span><span class="co">##  $ fYear   : Factor w/ 10 levels "1","2","3","4",..: 1 2 3 4 5 6 7 8 9 10 ...</span></span>
<span><span class="co">##  $ fPeriod : Factor w/ 6 levels "1","2","3","4",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##  $ fSite   : Factor w/ 50 levels "1","2","3","4",..: 1 1 1 1 1 1 1 1 1 1 ...</span></span></code></pre>
<p>Variables in dataset</p>
<dl>
<dt><code>Year</code></dt>
<dd>
The year of the observation as an integer
</dd>
<dt><code>fYear</code></dt>
<dd>
The year of the observation as a factor
</dd>
<dt><code>Period</code></dt>
<dd>
The period of the observation as an integer
</dd>
<dt><code>fPeriod</code></dt>
<dd>
The period of the observation as a factor
</dd>
<dt><code>Site</code></dt>
<dd>
The ID of the site as an integer
</dd>
<dt><code>fSite</code></dt>
<dd>
The ID of the site as a factor
</dd>
<dt><code>Mu</code></dt>
<dd>
The expected value of a negative binomial distribution
</dd>
<dt><code>Count</code></dt>
<dd>
A realisation of a negative binomial distribution with expected value
<code>Mu</code>
</dd>
<dt><code>Observed</code></dt>
<dd>
The <code>Count</code> variable with missing data
</dd>
</dl>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Mu</span>, group <span class="op">=</span> <span class="va">Site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Period</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="impute_files/figure-html/plot_data-1.png" alt="The dataset with missing observations." width="681.6"><p class="caption">
The dataset with missing observations.
</p>
</div>
</div>
<div class="section level2">
<h2 id="create-the-imputation-model">Create the imputation model<a class="anchor" aria-label="anchor" href="#create-the-imputation-model"></a>
</h2>
<p>We will create several models, mainly to illustrate the capabilities
of the <code>multimput</code> package. Hence several of the models are
not good for a real life application.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># a simple linear model</span></span>
<span><span class="va">imp_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Observed</span> <span class="op">~</span> <span class="va">fYear</span> <span class="op">+</span> <span class="va">fPeriod</span> <span class="op">+</span> <span class="va">fSite</span>, data <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span></span>
<span><span class="co"># a mixed model with Poisson distribution</span></span>
<span><span class="co"># fYear and fPeriod are the fixed effects</span></span>
<span><span class="co"># Site are independent and identically distributed random intercepts</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="va">imp_glmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/glmer.html" class="external-link">glmer</a></span><span class="op">(</span></span>
<span>  <span class="va">Observed</span> <span class="op">~</span> <span class="va">fYear</span> <span class="op">+</span> <span class="va">fPeriod</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">fSite</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  family <span class="op">=</span> <span class="va">poisson</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="co"># a mixed model with Poisson distribution</span></span>
<span><span class="co"># fYear and fPeriod are the fixed effects</span></span>
<span><span class="co"># Site are independent and identically distributed random intercepts</span></span>
<span><span class="co"># the same model as imp_glmm</span></span>
<span><span class="va">imp_inla_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span></span>
<span>  <span class="va">Observed</span> <span class="op">~</span> <span class="va">fYear</span> <span class="op">+</span> <span class="va">fPeriod</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Site</span>, model <span class="op">=</span> <span class="st">"iid"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>  control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>config <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>compute <span class="op">=</span> <span class="cn">TRUE</span>, link <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># the same model as imp_inla_p but with negative binomial distribution</span></span>
<span><span class="va">imp_inla_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span></span>
<span>  <span class="va">Observed</span> <span class="op">~</span> <span class="va">fYear</span> <span class="op">+</span> <span class="va">fPeriod</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">fSite</span>, model <span class="op">=</span> <span class="st">"iid"</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"nbinomial"</span>,</span>
<span>  control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>config <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>compute <span class="op">=</span> <span class="cn">TRUE</span>, link <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># a mixed model with negative binomial distribution</span></span>
<span><span class="co"># fPeriod is a fixed effect</span></span>
<span><span class="co"># f(Year, model = "rw1") is a global temporal trend</span></span>
<span><span class="co">#     modelled as a first order random walk</span></span>
<span><span class="co">#     delta_i = Year_i - Year_{i-1} with delta_i \sim N(0, \sigma_{rw1})</span></span>
<span><span class="co"># f(YearCopy, model = "ar1", replicate = Site) is a temporal trend per Site</span></span>
<span><span class="co">#     modelled as an first order autoregressive model</span></span>
<span><span class="co">#     Year_i_k = \rho Year_{i-1}_k + \epsilon_i_k with</span></span>
<span><span class="co">#     \epsilon_i_k \sim N(0, \sigma_{ar1})</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">YearCopy</span> <span class="op">&lt;-</span> <span class="va">dataset</span><span class="op">$</span><span class="va">Year</span></span>
<span><span class="va">imp_better</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span></span>
<span>  <span class="va">Observed</span> <span class="op">~</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Year</span>, model <span class="op">=</span> <span class="st">"rw1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">YearCopy</span>, model <span class="op">=</span> <span class="st">"ar1"</span>, replicate <span class="op">=</span> <span class="va">Site</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="va">fPeriod</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dataset</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"nbinomial"</span>,</span>
<span>  control.compute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>config <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>compute <span class="op">=</span> <span class="cn">TRUE</span>, link <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="apply-the-imputation-model">Apply the imputation model<a class="anchor" aria-label="anchor" href="#apply-the-imputation-model"></a>
</h2>
<p>Most models have a <code>predict</code> method. In such a case
<code><a href="../reference/impute.html">impute()</a></code> requires both a <code>model</code> and a
<code>data</code> argument. Note that this implies that one can apply an
imputation on any dataset as long as the dataset contains the necessary
variables.</p>
<p><code>inla</code> do the prediction simultaneously with the model
fitting. Hence the model contains all required information and the
<code>data</code> is not used.</p>
<p><code>n_imp</code> is the number of imputations. The default is
<code>n_imp = 19</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raw_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">imp_lm</span>, data <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span></span>
<span><span class="va">raw_glmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">imp_glmm</span>, data <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># setting `parallel_configs = FALSE` was required to pass R CMD Check</span></span>
<span><span class="co"># in practice you can use the default `parallel_configs = TRUE`</span></span>
<span><span class="va">raw_inla_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">imp_inla_p</span>, parallel_configs <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">raw_inla_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">imp_inla_nb</span>, parallel_configs <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">raw_better</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">imp_better</span>, parallel_configs <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">raw_better_9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/impute.html">impute</a></span><span class="op">(</span><span class="va">imp_better</span>, n_imp <span class="op">=</span> <span class="fl">9</span>, parallel_configs <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="aggregate-the-imputed-dataset">Aggregate the imputed dataset<a class="anchor" aria-label="anchor" href="#aggregate-the-imputed-dataset"></a>
</h2>
<p>Suppose that we are interested in the sum of the counts over all
sites for each combination of year and period. Then we must aggregate
the imputations on year and period. The resulting object will only
contain the imputed response and the grouping variables. The easiest way
to have a variable like year both a continuous and factor is to add both
<code>Year</code> and <code>fYear</code> to the
<code>grouping</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggr_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_impute.html">aggregate_impute</a></span><span class="op">(</span><span class="va">raw_lm</span>, grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="st">"fPeriod"</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span>
<span><span class="va">aggr_glmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_impute.html">aggregate_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">raw_glmm</span>, grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="st">"fPeriod"</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggr_inla_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_impute.html">aggregate_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">raw_inla_p</span>, grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="st">"fPeriod"</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span>
<span><span class="va">aggr_inla_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_impute.html">aggregate_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">raw_inla_nb</span>, grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="st">"fPeriod"</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span>
<span><span class="va">aggr_better</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_impute.html">aggregate_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">raw_better</span>, grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="st">"fPeriod"</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span>
<span><span class="va">aggr_better_9</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregate_impute.html">aggregate_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">raw_better_9</span>, grouping <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="st">"fPeriod"</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-the-aggregated-imputed-dataset">Model the aggregated imputed dataset<a class="anchor" aria-label="anchor" href="#model-the-aggregated-imputed-dataset"></a>
</h2>
<div class="section level3">
<h3 id="simple-example">Simple example<a class="anchor" aria-label="anchor" href="#simple-example"></a>
</h3>
<p><code><a href="../reference/model_impute.html">model_impute()</a></code> will apply the <code>model_fun</code> to
each imputation set. The covariates are defined in the <code>rhs</code>
argument. So <code>model_fun = lm</code> in combination with
<code>rhs = "0 + fYear + fPeriod"</code> is equivalent to
<code>lm(ImputedResponse ~ 0 + fYear + fPeriod, data = ImputedData)</code>.</p>
<p>The tricky part of this function the <code>extractor</code> argument.
This is a user defined function which must have an argument called
<code>model</code>. The function should return a <code>data.frame</code>
or <code>matrix</code> with two columns. The first column hold the
estimate of a parameter of the <code>model</code>, the second column
their standard error. Each row represents a parameter.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extractor_lm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"Std. Error"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">aggr_lm</span>, model_fun <span class="op">=</span> <span class="va">lm</span>, rhs <span class="op">=</span> <span class="st">"0 + fYear + fPeriod"</span>, extractor <span class="op">=</span> <span class="va">extractor_lm</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 15 × 5</span></span></span>
<span><span class="co">##    Parameter Estimate    SE   LCL   UCL</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> fYear1       795.   166.  469. <span style="text-decoration: underline;">1</span>121.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> fYear2       858.   174.  517. <span style="text-decoration: underline;">1</span>199.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> fYear3      <span style="text-decoration: underline;">1</span>152.   157.  845. <span style="text-decoration: underline;">1</span>459.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> fYear4      <span style="text-decoration: underline;">1</span>472.   159. <span style="text-decoration: underline;">1</span>161. <span style="text-decoration: underline;">1</span>784.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> fYear5       922.   159.  610. <span style="text-decoration: underline;">1</span>233.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> fYear6      <span style="text-decoration: underline;">1</span>539.   162. <span style="text-decoration: underline;">1</span>222. <span style="text-decoration: underline;">1</span>855.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> fYear7      <span style="text-decoration: underline;">1</span>508.   164. <span style="text-decoration: underline;">1</span>187. <span style="text-decoration: underline;">1</span>829.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> fYear8      <span style="text-decoration: underline;">1</span>262.   173.  923. <span style="text-decoration: underline;">1</span>601.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> fYear9      <span style="text-decoration: underline;">1</span>200.   162.  883. <span style="text-decoration: underline;">1</span>518.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> fYear10     <span style="text-decoration: underline;">1</span>285.   154.  982. <span style="text-decoration: underline;">1</span>587.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">11</span> fPeriod2     532.   136.  266.  799.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">12</span> fPeriod3     451.   149.  158.  744.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">13</span> fPeriod4     555.   142.  276.  833.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">14</span> fPeriod5     -<span style="color: #BB0000;">72.6</span>  142. -<span style="color: #BB0000;">350.</span>  205.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">15</span> fPeriod6    -<span style="color: #BB0000;">484.</span>   141. -<span style="color: #BB0000;">760.</span> -<span style="color: #BB0000;">208.</span></span></span></code></pre>
</div>
<div class="section level3">
<h3 id="return-only-the-parameters-associated-with-fyear">Return only the parameters associated with <code>fYear</code><a class="anchor" aria-label="anchor" href="#return-only-the-parameters-associated-with-fyear"></a>
</h3>
<p>The <code>extractor</code> function requires more work from the user.
This cost is compensated by the high degree of flexibility. The user
doesn’t depend on the predefined extractor functions. This is
illustrated by the following examples.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extractor_lm2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span></span>
<span>  <span class="va">cf</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cf</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"Std. Error"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">aggr_lm</span>, model_fun <span class="op">=</span> <span class="va">lm</span>, rhs <span class="op">=</span> <span class="st">"0 + fYear + fPeriod"</span>,</span>
<span>  extractor <span class="op">=</span> <span class="va">extractor_lm2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">##    Parameter Estimate    SE   LCL   UCL</span></span>
<span><span class="co">##    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span> fYear1        795.  166.  469. <span style="text-decoration: underline;">1</span>121.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span> fYear2        858.  174.  517. <span style="text-decoration: underline;">1</span>199.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span> fYear3       <span style="text-decoration: underline;">1</span>152.  157.  845. <span style="text-decoration: underline;">1</span>459.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span> fYear4       <span style="text-decoration: underline;">1</span>472.  159. <span style="text-decoration: underline;">1</span>161. <span style="text-decoration: underline;">1</span>784.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span> fYear5        922.  159.  610. <span style="text-decoration: underline;">1</span>233.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span> fYear6       <span style="text-decoration: underline;">1</span>539.  162. <span style="text-decoration: underline;">1</span>222. <span style="text-decoration: underline;">1</span>855.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span> fYear7       <span style="text-decoration: underline;">1</span>508.  164. <span style="text-decoration: underline;">1</span>187. <span style="text-decoration: underline;">1</span>829.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span> fYear8       <span style="text-decoration: underline;">1</span>262.  173.  923. <span style="text-decoration: underline;">1</span>601.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span> fYear9       <span style="text-decoration: underline;">1</span>200.  162.  883. <span style="text-decoration: underline;">1</span>518.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span> fYear10      <span style="text-decoration: underline;">1</span>285.  154.  982. <span style="text-decoration: underline;">1</span>587.</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="predict-a-smoother-for-predefined-values">Predict a smoother for predefined values<a class="anchor" aria-label="anchor" href="#predict-a-smoother-for-predefined-values"></a>
</h3>
<p>Note that we pass extra arguments to the <code>extractor</code>
function through the <code>extractor_args</code> argument. This has to
be a list. We recommend to use a named list to avoid confusion.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="va">new_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>  Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/pretty.html" class="external-link">pretty</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">Year</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>  fPeriod <span class="op">=</span> <span class="va">dataset</span><span class="op">$</span><span class="va">fPeriod</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="va">extractor_lm3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">newdata</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">newdata</span>, se.fit <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">predictions</span><span class="op">$</span><span class="va">fit</span>, <span class="va">predictions</span><span class="op">$</span><span class="va">se.fit</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">model_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  <span class="va">aggr_lm</span>, model_fun <span class="op">=</span> <span class="va">gam</span>, rhs <span class="op">=</span> <span class="st">"s(Year) + fPeriod"</span>,</span>
<span>  extractor <span class="op">=</span> <span class="va">extractor_lm3</span>, extractor_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>newdata <span class="op">=</span> <span class="va">new_set</span><span class="op">)</span>,</span>
<span>  mutate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Year <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">fYear</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">fYear</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">new_set</span>, <span class="va">model_gam</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">model_gam</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Estimate</span>, ymin <span class="op">=</span> <span class="va">LCL</span>, ymax <span class="op">=</span> <span class="va">UCL</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="impute_files/figure-html/model_aggregate_lm3-1.png" alt="The estimated trend for the years." width="681.6"><p class="caption">
The estimated trend for the years.
</p>
</div>
</div>
<div class="section level3">
<h3 id="compare-the-results-using-different-imputation-models">Compare the results using different imputation models<a class="anchor" aria-label="anchor" href="#compare-the-results-using-different-imputation-models"></a>
</h3>
<div class="section level4">
<h4 id="modelling-aggregated-data-with-glm-nb">Modelling aggregated data with <code>glm.nb</code><a class="anchor" aria-label="anchor" href="#modelling-aggregated-data-with-glm-nb"></a>
</h4>
<p>Suppose that we are interested in a yearly relative index taking into
account the average seasonal pattern. With a complete dataset (without
missing values) we could model it like the example below: a generalised
linear model with negative binomial distribution because we have counts
that are likely overdispersed. <code>fYear</code> models the yearly
index and <code>fPeriod</code> the average seasonal pattern. The
<code>0 +</code> part removes the intercept for the model. This simple
trick gives direct estimates for the effect of <code>fYear</code>.</p>
<p>Only the effects of <code>fYear</code> are needed for the index.
Therefore the extractor functions selects only the parameters who’s row
name contains <code>fYear</code>. In case that we want the first year to
be used as a reference (index year 1 = 100%), we can subtract the
estimate for this year from all estimates. The result are the indices
relative to the first year, but still in the log scale. Note that the
estimated index for year 1 will be 0 and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>100</mn><mi>%</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">log(100\%) = 0</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/" class="external-link">MASS</a></span><span class="op">)</span></span>
<span><span class="va">aggr_complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span></span>
<span>  <span class="va">dataset</span><span class="op">[</span>, <span class="st">"Count"</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">dataset</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="st">"fPeriod"</span><span class="op">)</span><span class="op">]</span>, FUN <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MASS/man/glm.nb.html" class="external-link">glm.nb</a></span><span class="op">(</span><span class="va">Count</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">fYear</span> <span class="op">+</span> <span class="va">fPeriod</span>, data <span class="op">=</span> <span class="va">aggr_complete</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_complete</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## glm.nb(formula = Count ~ 0 + fYear + fPeriod, data = aggr_complete, </span></span>
<span><span class="co">##     init.theta = 31.78765186, link = log)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##          Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">## fYear1    6.72514    0.09016  74.590  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear2    6.83730    0.09005  75.929  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear3    7.06993    0.08985  78.684  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear4    7.09550    0.08983  78.985  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear5    6.94750    0.08995  77.237  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear6    7.13813    0.08980  79.487  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear7    7.23272    0.08974  80.597  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear8    7.16345    0.08979  79.784  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear9    7.05221    0.08987  78.475  &lt; 2e-16 ***</span></span>
<span><span class="co">## fYear10   7.10071    0.08983  79.046  &lt; 2e-16 ***</span></span>
<span><span class="co">## fPeriod2  0.36211    0.08027   4.511 6.44e-06 ***</span></span>
<span><span class="co">## fPeriod3  0.41944    0.08024   5.227 1.72e-07 ***</span></span>
<span><span class="co">## fPeriod4  0.34524    0.08027   4.301 1.70e-05 ***</span></span>
<span><span class="co">## fPeriod5 -0.02515    0.08045  -0.313    0.755    </span></span>
<span><span class="co">## fPeriod6 -0.47112    0.08076  -5.833 5.44e-09 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## (Dispersion parameter for Negative Binomial(31.7877) family taken to be 1)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     Null deviance: 541101.695  on 60  degrees of freedom</span></span>
<span><span class="co">## Residual deviance:     60.596  on 45  degrees of freedom</span></span>
<span><span class="co">## AIC: 852.28</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of Fisher Scoring iterations: 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##               Theta:  31.79 </span></span>
<span><span class="co">##           Std. Err.:  5.96 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  2 x log-likelihood:  -820.275</span></span></code></pre>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extractor_logindex</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span></span>
<span>  <span class="va">log_index</span> <span class="op">&lt;-</span> <span class="va">coef</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">coef</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"Std. Error"</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">log_index</span><span class="op">[</span>, <span class="st">"Estimate"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">log_index</span><span class="op">[</span>, <span class="st">"Estimate"</span><span class="op">]</span> <span class="op">-</span></span>
<span>    <span class="va">log_index</span><span class="op">[</span><span class="st">"fYear1"</span>, <span class="st">"Estimate"</span><span class="op">]</span></span>
<span>  <span class="va">log_index</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now that we have a relevant model and extractor function, we can
apply them to the aggregate imputed datasets.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_glmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">aggr_glmm</span>, model_fun <span class="op">=</span> <span class="va">glm.nb</span>, rhs <span class="op">=</span> <span class="st">"0 + fYear + fPeriod"</span>,</span>
<span>  extractor <span class="op">=</span> <span class="va">extractor_logindex</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">aggr_inla_p</span>, model_fun <span class="op">=</span> <span class="va">glm.nb</span>, rhs <span class="op">=</span> <span class="st">"0 + fYear + fPeriod"</span>,</span>
<span>  extractor <span class="op">=</span> <span class="va">extractor_logindex</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">aggr_inla_nb</span>, model_fun <span class="op">=</span> <span class="va">glm.nb</span>, rhs <span class="op">=</span> <span class="st">"0 + fYear + fPeriod"</span>,</span>
<span>  extractor <span class="op">=</span> <span class="va">extractor_logindex</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_better</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">aggr_better</span>, model_fun <span class="op">=</span> <span class="va">glm.nb</span>, rhs <span class="op">=</span> <span class="st">"0 + fYear + fPeriod"</span>,</span>
<span>  extractor <span class="op">=</span> <span class="va">extractor_logindex</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_complete</span> <span class="op">&lt;-</span> <span class="fu">extractor_logindex</span><span class="op">(</span><span class="va">model_complete</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">model_complete</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"SE"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">model_complete</span> <span class="op">&lt;-</span> <span class="va">model_complete</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    LCL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="va">Estimate</span>, <span class="va">SE</span><span class="op">)</span>,</span>
<span>    UCL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span>, <span class="va">Estimate</span>, <span class="va">SE</span><span class="op">)</span>,</span>
<span>    Parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">covar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combine all results and add the Year</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_glmm</span>, Model <span class="op">=</span> <span class="st">"glmm"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_p</span>, Model <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_nb</span>, Model <span class="op">=</span> <span class="st">"negative binomial"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_better</span>, Model <span class="op">=</span> <span class="st">"better"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_complete</span>, Model <span class="op">=</span> <span class="st">"complete"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># convert estimate and confidence interval to the original scale</span></span>
<span><span class="va">parameters</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"LCL"</span>, <span class="st">"UCL"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span></span>
<span>  <span class="va">parameters</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"LCL"</span>, <span class="st">"UCL"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Estimate</span>, ymin <span class="op">=</span> <span class="va">LCL</span>, ymax <span class="op">=</span> <span class="va">UCL</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Model</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="impute_files/figure-html/model_glmnb_plot-1.png" alt="The estimated relative index for the years." width="681.6"><p class="caption">
The estimated relative index for the years.
</p>
</div>
</div>
<div class="section level4">
<h4 id="modelling-aggregated-data-with-inla">Modelling aggregated data with <code>inla</code><a class="anchor" aria-label="anchor" href="#modelling-aggregated-data-with-inla"></a>
</h4>
<p>The example below does something similar. Two things are different:
1) instead of <code>glm.nb</code> we use <code>inla</code> to model the
imputed totals. 2) we model the seasonal pattern as a random intercept
instead of a fixed effect.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extractor_inla</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fe</span> <span class="op">&lt;-</span> <span class="va">model</span><span class="op">$</span><span class="va">summary.fixed</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"sd"</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">log_index</span> <span class="op">&lt;-</span> <span class="va">fe</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fe</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="va">log_index</span><span class="op">[</span>, <span class="st">"mean"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">log_index</span><span class="op">[</span>, <span class="st">"mean"</span><span class="op">]</span> <span class="op">-</span> <span class="va">log_index</span><span class="op">[</span><span class="st">"fYear1"</span>, <span class="st">"mean"</span><span class="op">]</span></span>
<span>  <span class="va">log_index</span></span>
<span><span class="op">}</span></span>
<span><span class="va">model_p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">aggr_glmm</span>, model_fun <span class="op">=</span> <span class="va">inla</span>,</span>
<span>  rhs <span class="op">=</span> <span class="st">"0 + fYear + f(fPeriod, model = 'iid')"</span>,</span>
<span>  model_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"nbinomial"</span><span class="op">)</span>, extractor <span class="op">=</span> <span class="va">extractor_inla</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">aggr_inla_nb</span>, model_fun <span class="op">=</span> <span class="va">inla</span>,</span>
<span>  rhs <span class="op">=</span> <span class="st">"0 + fYear + f(fPeriod, model = 'iid')"</span>,</span>
<span>  model_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"nbinomial"</span><span class="op">)</span>, extractor <span class="op">=</span> <span class="va">extractor_inla</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_better</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model_impute.html">model_impute</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">aggr_better</span>, model_fun <span class="op">=</span> <span class="va">inla</span>,</span>
<span>  rhs <span class="op">=</span> <span class="st">"0 + fYear + f(fPeriod, model = 'iid')"</span>,</span>
<span>  model_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"nbinomial"</span><span class="op">)</span>, extractor <span class="op">=</span> <span class="va">extractor_inla</span></span>
<span><span class="op">)</span></span>
<span><span class="va">m_complete</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span></span>
<span>  <span class="va">Count</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">fYear</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">fPeriod</span>, model <span class="op">=</span> <span class="st">"iid"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">aggr_complete</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"nbinomial"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_complete</span> <span class="op">&lt;-</span> <span class="fu">extractor_inla</span><span class="op">(</span><span class="va">m_complete</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">model_complete</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"SE"</span><span class="op">)</span></span>
<span><span class="va">model_complete</span> <span class="op">&lt;-</span> <span class="va">model_complete</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    LCL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="va">Estimate</span>, <span class="va">SE</span><span class="op">)</span>,</span>
<span>    UCL <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span>, <span class="va">Estimate</span>, <span class="va">SE</span><span class="op">)</span>,</span>
<span>    Parameter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fYear"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co"># combine all results and add the Year</span></span>
<span><span class="va">parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_glmm</span>, Model <span class="op">=</span> <span class="st">"glmm"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_p</span>, Model <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_nb</span>, Model <span class="op">=</span> <span class="st">"negative binomial"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_better</span>, Model <span class="op">=</span> <span class="st">"better"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">covar</span>, <span class="va">model_complete</span>, Model <span class="op">=</span> <span class="st">"complete"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># convert estimate and confidence interval to the original scale</span></span>
<span><span class="va">parameters</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"LCL"</span>, <span class="st">"UCL"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span></span>
<span>  <span class="va">parameters</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Estimate"</span>, <span class="st">"LCL"</span>, <span class="st">"UCL"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">parameters</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Year</span>, y <span class="op">=</span> <span class="va">Estimate</span>, ymin <span class="op">=</span> <span class="va">LCL</span>, ymax <span class="op">=</span> <span class="va">UCL</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Model</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="impute_files/figure-html/model_inla-1.png" alt="The estimated relative index for the years." width="681.6"><p class="caption">
The estimated relative index for the years.
</p>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Onkelinx2016" class="csl-entry">
Onkelinx, Thierry, Koen Devos, and Paul Quataert. 2016. <span>“Working
with Population Totals in the Presence of Missing Data Comparing
Imputation Methods in Terms of Bias and Precision.”</span> <em>Journal
of Ornithology</em>, 1–13. <a href="https://doi.org/10.1007/s10336-016-1404-9" class="external-link">https://doi.org/10.1007/s10336-016-1404-9</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Thierry Onkelinx, Koen Devos, Paul Quataert, <a href="https://www.vlaanderen.be/inbo/en-gb" class="external-link"><img src="https://inbo.github.io/checklist/reference/figures/logo-en.png" height="24" alt="logo of the Research Institute for Nature and Forest (INBO)"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
